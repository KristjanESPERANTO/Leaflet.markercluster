<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Spec Runner</title>
    <link rel="stylesheet" type="text/css" href="../node_modules/mocha/mocha.css" />
    <link rel="stylesheet" type="text/css" href="../node_modules/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="../dist/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="../dist/MarkerCluster.Default.css" />

    <script type="importmap">
      {
        "imports": {
          "leaflet": "../node_modules/leaflet/dist/leaflet-src.js",
          "leaflet.markercluster": "../dist/leaflet.markercluster.js"
        }
      }
    </script>
  </head>
  <body>
    <div id="mocha"></div>
    <script type="text/javascript" src="../node_modules/mocha/mocha.js"></script>
    <script type="text/javascript" src="../node_modules/happen/happen.js"></script>
    <script type="text/javascript" src="../node_modules/sinon/pkg/sinon.js"></script>
    <script type="module">
      import { Icon } from "leaflet";
      import * as chai from "../node_modules/chai/index.js";

      // Setup Chai - use expect assertion style
      window.expect = chai.expect;

      Icon.Default.imagePath = "../node_modules/leaflet/dist/images/";

      mocha.setup("bdd");

      const testSuites = [
        "./suites/SpecHelper.js",
        "./suites/LeafletSpec.js",
        "./suites/DistanceGridSpec.js",
        "./suites/QuickHullSpec.js",
        "./suites/AddLayer.MultipleSpec.js",
        "./suites/AddLayer.SingleSpec.js",
        "./suites/AddLayersSpec.js",
        "./suites/animateOptionSpec.js",
        "./suites/singleMarkerModeSpec.js",
        "./suites/ChildChangingIconSupportSpec.js",
        "./suites/markerMoveSupportSpec.js",
        "./suites/CircleMarkerSupportSpec.js",
        "./suites/CircleSupportSpec.js",
        "./suites/clusterMarkerTitleSpec.js",
        "./suites/onAddSpec.js",
        "./suites/onRemoveSpec.js",
        "./suites/clearLayersSpec.js",
        "./suites/eachLayerSpec.js",
        "./suites/eventsSpec.js",
        "./suites/getBoundsSpec.js",
        "./suites/getLayersSpec.js",
        "./suites/getVisibleParentSpec.js",
        "./suites/NonPointSpec.js",
        "./suites/PaneSpec.js",
        "./suites/RemoveLayerSpec.js",
        "./suites/removeLayersSpec.js",
        "./suites/spiderfySpec.js",
        "./suites/unspiderfySpec.js",
        "./suites/zoomAnimationSpec.js",
        "./suites/RememberOpacity.js",
        "./suites/supportNegativeZoomSpec.js",
        "./suites/RefreshSpec.js",
        "./suites/removeOutsideVisibleBoundsSpec.js",
        "./suites/nonIntegerZoomSpec.js",
        "./suites/disableClusteringAtZoomSpec.js"
      ];

      for (const suite of testSuites) {
        await import(suite);
      }

      // Signal that scripts are loaded
      window.scriptsLoaded = true;

      console.log("Module loaded, starting tests...");

      // NOW run the tests after module is fully loaded
      const runner = window.mocha.run();

      // Store results for automated testing
      window.mochaResults = null;
      const failedTests = [];

      // Collect failures as they happen
      runner.on("fail", function (test, err) {
        failedTests.push({
          title: test.fullTitle(),
          error: err.message || err.toString()
        });
      });

      runner.on("end", function () {
        console.log("End event fired! Stats:", runner.stats);
        window.mochaResults = {
          passes: runner.stats.passes || 0,
          failures: runner.stats.failures || 0,
          pending: runner.stats.pending || 0,
          duration: runner.stats.duration || 0,
          failureDetails: failedTests
        };

        console.log("Tests complete:", window.mochaResults.passes, "passed,", window.mochaResults.failures, "failed,", window.mochaResults.pending, "skipped");
        console.log("mochaResults set:", window.mochaResults);
      });
    </script>
  </body>
</html>
